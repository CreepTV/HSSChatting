<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HSSChatting</title>
  <style>
    :root{--bg:#f3f6fb;--accent:#2b7de9;--muted:#6b7280;--card:#ffffff;--own:#d9eefc;--other:#ffffff}
    html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Helvetica,Arial;background:var(--bg);color:#0b1220}
    .app{display:flex;height:100vh}
    .sidebar{width:240px;background:var(--card);border-right:1px solid #e6e9ef;padding:18px;box-sizing:border-box;display:flex;flex-direction:column}
    .brand{font-weight:800;color:var(--accent);margin-bottom:8px;font-size:18px}
    .user-info{font-size:13px;color:var(--muted);margin-bottom:8px}
    .users{margin-top:8px;overflow:auto;flex:1}
    .users button{display:flex;align-items:center;gap:8px;width:100%;text-align:left;padding:8px;border:0;background:transparent;border-radius:6px;margin-bottom:6px;cursor:pointer}
    .users button:hover{background:#f1f5fb}
    .users button .badge{margin-left:auto;background:#ff4d4f;color:white;border-radius:12px;font-size:11px;padding:2px 6px}
    .avatar{width:32px;height:32px;border-radius:6px;background:#eef4ff;color:var(--accent);display:inline-flex;align-items:center;justify-content:center;font-weight:700}

    .main{flex:1;display:flex;flex-direction:column}
    .header{padding:12px 16px;border-bottom:1px solid #e6e9ef;display:flex;align-items:center;justify-content:space-between;background:var(--card)}
    .channels{display:flex;gap:8px}
    .channel-btn{padding:6px 10px;border-radius:6px;border:1px solid transparent;background:transparent;cursor:pointer;position:relative}
    .channel-btn.active{background:var(--accent);color:white}
    .channel-btn .badge{position:absolute;top:-6px;right:-6px;background:#ff4d4f;color:white;border-radius:100%;font-size:10px;padding:2px 6px}
    .chat-area{flex:1;padding:16px;overflow:auto;display:flex;flex-direction:column;background:var(--bg)}
    .messages{flex:1;overflow:auto;padding-right:8px;display:flex;flex-direction:column}
    .composer{display:flex;padding:12px;border-top:1px solid #e6e9ef;background:var(--card);align-items:center}
    .composer input{flex:1;padding:10px;border:1px solid #e6e9ef;border-radius:8px;margin-right:8px;font-size:14px}
    .composer button{background:var(--accent);color:white;border:0;padding:9px 14px;border-radius:8px;font-weight:600}

    .msg{padding:10px;border-radius:12px;margin-bottom:10px;max-width:64%;word-wrap:break-word}
    .msg.own{background:var(--own);margin-left:auto;color:#042033}
    .msg.other{background:var(--other);margin-right:auto;color:#042033}
    .msg.system{background:transparent;color:var(--muted);text-align:center;max-width:100%}
    .msg .meta{display:flex;justify-content:space-between;align-items:center;font-size:12px;color:var(--muted);margin-bottom:6px}
    .msg .meta .who{font-weight:700;color:#0b1220}
    .msg .meta .time{font-size:11px}
    .private-badge{font-size:11px;background:#ffefd5;border-radius:4px;padding:2px 6px;margin-left:8px;color:#a45b00}
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">HSSChatting</div>
      <div class="user-info">Du: <strong id="me">-</strong></div>
      <div><strong>Online</strong></div>
      <div class="users" id="users"></div>
      <div style="margin-top:16px;color:var(--muted);font-size:13px">Tipp: Klick auf einen Nutzer, um einen privaten Chat zu öffnen.</div>

      <div class="settings" id="settings" style="border-top:1px solid #e6e9ef;padding-top:12px;margin-top:12px">
        <div style="font-size:13px;color:var(--muted)">Einstellungen</div>
        <div style="margin-top:8px">
          <input id="set-nick" placeholder="Dein Nick" style="width:100%;padding:8px;border:1px solid #e6e9ef;border-radius:6px" />
          <button id="save-nick" style="margin-top:8px;width:100%;padding:8px;border-radius:6px;background:var(--accent);color:white;border:0">Speichern</button>
        </div>
      </div>
    </aside>

    <main class="main">
      <div class="header">
        <div class="channels">
          <button class="channel-btn active" data-channel="all">Hauptchat</button>
        </div>
        <div id="channel-label" style="color:var(--muted)">Verbunden</div>
      </div>

      <div class="chat-area">
        <div class="messages" id="messages"></div>
      </div>

      <div class="composer">
        <input id="msg" placeholder="Nachricht..." autocomplete="off" />
        <button id="send">Senden</button>
      </div>
    </main>
  </div>

<script>
(function(){
  const usersDiv = document.getElementById('users');
  const messagesDiv = document.getElementById('messages');
  const msgInput = document.getElementById('msg');
  const sendBtn = document.getElementById('send');
  const meSpan = document.getElementById('me');
  const channelsDiv = document.querySelector('.channels');
  const channelLabel = document.getElementById('channel-label');

  const storedNick = localStorage.getItem('hss_nick');
  let nick = storedNick || prompt('Dein Nickname für den Chat', storedNick || 'Gast');
  if(!nick) nick = 'Gast';
  let myName = nick;
  let currentChannel = 'all'; // 'all' or username

  const ws = new WebSocket((location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws');

  const messages = { all: [] }; // messages['all'] and messages['username']

  function formatTime(ts){ try{ const d = new Date(ts); return d.toLocaleTimeString(); }catch(e){ return ''; } }

  function renderChannel(channel){
    messagesDiv.innerHTML = '';
    const list = messages[channel] || [];
    list.forEach(m=>{
      const el = document.createElement('div');
      if(m.user === '_system'){
        el.className = 'msg system';
        const meta = document.createElement('div'); meta.className='meta';
        meta.textContent = `${formatTime(m.ts)} · System`;
        el.appendChild(meta);
        const body = document.createElement('div'); body.textContent = m.text; el.appendChild(body);
      } else {
        const isOwn = (m.user === myName);
        el.className = 'msg ' + (isOwn ? 'own' : 'other');
        const meta = document.createElement('div'); meta.className = 'meta';
        const who = document.createElement('div'); who.className='who'; who.textContent = isOwn ? (m.user + ' (du)') : m.user;
        const right = document.createElement('div'); right.className='time'; right.textContent = formatTime(m.ts);
        meta.appendChild(who); meta.appendChild(right);
        if(m.private){
          const pb = document.createElement('span'); pb.className='private-badge'; pb.textContent='Privat'; meta.appendChild(pb);
        }
        const body = document.createElement('div'); body.textContent = m.text;
        el.appendChild(meta);
        el.appendChild(body);
      }
      messagesDiv.appendChild(el);
    });
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
    const title = channel === 'all' ? 'Hauptchat' : `Privat: ${channel}`;
    channelLabel.textContent = title;
    // update active channel button
    Array.from(document.querySelectorAll('.channel-btn')).forEach(b=>{
      const active = b.dataset.channel === channel;
      b.classList.toggle('active', active);
      if(active){
        // clear unread badge
        const badge = b.querySelector('.badge'); if(badge) badge.remove(); b.dataset.unread = 0;
      }
    });
  }

  function addMessageTo(channel, msg){
    messages[channel] = messages[channel] || [];
    messages[channel].push(msg);
  }

  ws.addEventListener('open', ()=>{ ws.send(JSON.stringify({type:'join', user:nick})); });

  ws.addEventListener('message', (ev)=>{
    try{
      const data = JSON.parse(ev.data);
      if(data.type === 'message'){
        if(data.private){
          // private: determine channel (other user)
          const other = (data.user === myName) ? data.to : data.user;
          addMessageTo(other, data);
          // find or create a sidebar user button and show unread there
          let userBtn = Array.from(usersDiv.querySelectorAll('button')).find(b => b.textContent && b.textContent.trim() === other);
          if(!userBtn){
            userBtn = document.createElement('button');
            const av = document.createElement('div'); av.className='avatar'; av.textContent = other.slice(0,2).toUpperCase();
            userBtn.appendChild(av);
            const txt = document.createElement('div'); txt.textContent = other; userBtn.appendChild(txt);
            const b = document.createElement('span'); b.className='badge'; userBtn.appendChild(b);
            userBtn.addEventListener('click', ()=>{ currentChannel = other; renderChannel(currentChannel); ws.send(JSON.stringify({type:'history', channel:other})); const bb = userBtn.querySelector('.badge'); if(bb) bb.remove(); userBtn.dataset.unread = 0; });
            usersDiv.appendChild(userBtn);
          }
          // if not currently viewing that channel, show unread badge
          if(currentChannel !== other){
            const count = parseInt(userBtn.dataset.unread||0) + 1; userBtn.dataset.unread = count;
            let badge = userBtn.querySelector('.badge'); if(!badge){ badge = document.createElement('span'); badge.className='badge'; userBtn.appendChild(badge); }
            badge.textContent = String(count);
          }
          if(currentChannel === other) renderChannel(currentChannel);
        } else {
          // public message
          addMessageTo('all', data);
          if(currentChannel === 'all') renderChannel('all');
        }
      } else if(data.type === 'user_list'){
        // update users list
        usersDiv.innerHTML = '';
        data.users.forEach(u=>{
          const existing = Array.from(usersDiv.querySelectorAll('button')).find(b => b.textContent && b.textContent.trim() === u);
          if(existing) return; // avoid duplicates
          const btn = document.createElement('button');
          const av = document.createElement('div'); av.className='avatar'; av.textContent = u.slice(0,2).toUpperCase();
          btn.appendChild(av);
          const txt = document.createElement('div'); txt.textContent = u; btn.appendChild(txt);
          const badge = document.createElement('span'); badge.className='badge'; badge.style.display='none'; btn.appendChild(badge);
          btn.addEventListener('click', ()=>{ 
            currentChannel = u; 
            renderChannel(currentChannel);
            // request DM history from server
            ws.send(JSON.stringify({type:'history', channel:u}));
            // clear unread badge on this user
            badge.remove(); btn.dataset.unread = 0; 
          });
          usersDiv.appendChild(btn);
        });
      } else if(data.type === 'joined'){
        myName = data.user; meSpan.textContent = myName; localStorage.setItem('hss_nick', myName); addMessageTo('all', {user:'_system', text:`Dein Nick ist jetzt: ${myName}`, ts:data.ts||new Date().toISOString()}); renderChannel(currentChannel);
      } else if(data.type === 'renamed'){
        myName = data.user; meSpan.textContent = myName; localStorage.setItem('hss_nick', myName); addMessageTo('all', {user:'_system', text:`${data.old} heißt jetzt ${data.user}`, ts:data.ts||new Date().toISOString()}); renderChannel(currentChannel);
      } else if(data.type === 'history'){
        const ch = data.channel || 'all';
        messages[ch] = data.messages || [];
        if(currentChannel === ch) renderChannel(ch);
      }
    }catch(e){ console.error(e); }
  });

  // settings elements
  const nickInput = document.getElementById('set-nick');
  const saveNickBtn = document.getElementById('save-nick');
  if(nickInput) nickInput.value = localStorage.getItem('hss_nick') || nick;

  saveNickBtn.addEventListener('click', ()=>{
    const newNick = (nickInput.value || '').trim(); if(!newNick) return; ws.send(JSON.stringify({type:'rename', user:newNick}));
  });

  // send message
  sendBtn.addEventListener('click', ()=>{
    const text = msgInput.value.trim(); if(!text) return;
    const to = currentChannel || 'all';
    ws.send(JSON.stringify({type:'message', text, to}));
    msgInput.value = '';
  });

  msgInput.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') sendBtn.click(); });

  // channel button (main)
  document.querySelector('.channel-btn[data-channel="all"]').addEventListener('click', ()=>{ currentChannel='all'; renderChannel('all'); ws.send(JSON.stringify({type:'history', channel:'all'})); });

  window.addEventListener('beforeunload', ()=>{ try{ ws.send(JSON.stringify({type:'leave'})); }catch(e){} ws.close(); });
})();
</script>
</body>
</html>